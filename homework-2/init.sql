-- ФИО студента: Тонкушин Дмитрий Алексеевич
-- Вариант: 4
-- Описание предметной области:
-- Описание хранящихся на складе товаров. Включает в себя: описание помещений, описание стеллажей, описание клиентов, описание товаров, хранящихся на стеллажах.
-- Описание помещения состоит из: названия, полезного объёма, температурных и влажностных условий. 
-- Описание стеллажа состоит из: номера, указания помещения, в котором стеллаж находится, количества мест для хранения в стеллаже, высоты, ширины и длины одного места, максимальной суммарной нагрузки.
-- Описание клиента состоит из: названия юридического лица и банковских реквизитов в виде большого текста.
-- Описание товара, хранящегося на стеллажах, состоит из: высоты, ширины, длины, веса, даты поступления, номера договора, указания, от какого клиента поступил, даты окончания договора, температурных и влажностных условий хранения, указания стеллажа, и позиции размещения на нём, представляемой в виде целого номера.
-- На одном стеллаже могут храниться товары разных клиентов.

-- Удаление таблиц, если они существуют (для возможности повторного выполнения скрипта)
DROP TABLE IF EXISTS product CASCADE;
DROP TABLE IF EXISTS rack CASCADE;
DROP TABLE IF EXISTS client CASCADE;
DROP TABLE IF EXISTS room CASCADE;

-- Создание структуры базы данных
CREATE TABLE room (
    id uuid PRIMARY KEY,
    name varchar NOT NULL UNIQUE,
    volume DECIMAL(10,3) NOT NULL,
    storage_temperature_min DECIMAL(5,2) NOT NULL,
    storage_temperature_max DECIMAL(5,2) NOT NULL,
    storage_humidity_min DECIMAL(5,2) NOT NULL,
    storage_humidity_max DECIMAL(5,2) NOT NULL,
    CHECK (storage_temperature_min <= storage_temperature_max),
    CHECK (storage_humidity_min <= storage_humidity_max)
);

CREATE TABLE rack (
    id uuid PRIMARY KEY,
    rack_number varchar NOT NULL,
    room_id uuid NOT NULL REFERENCES room(id),
    positions_count integer NOT NULL,
    position_height DECIMAL(10,3) NOT NULL,
    position_width DECIMAL(10,3) NOT NULL,
    position_length DECIMAL(10,3) NOT NULL,
    max_total_weight DECIMAL(10,3) NOT NULL,
    UNIQUE (room_id, rack_number)
);

CREATE TABLE client (
    id uuid PRIMARY KEY,
    company_name varchar NOT NULL,
    bank_details text NOT NULL,
    UNIQUE(company_name, bank_details)
);

CREATE TABLE product (
    id uuid PRIMARY KEY,
    height DECIMAL(10,3) NOT NULL,
    width DECIMAL(10,3) NOT NULL,
    length DECIMAL(10,3) NOT NULL,
    weight DECIMAL(10,3) NOT NULL,
    receipt_date date NOT NULL,
    contract_number varchar NOT NULL,
    client_id uuid NOT NULL REFERENCES client(id),
    contract_end_date date NOT NULL,
    storage_temperature_min DECIMAL(5,2) NOT NULL,
    storage_temperature_max DECIMAL(5,2) NOT NULL,
    storage_humidity_min DECIMAL(5,2) NOT NULL,
    storage_humidity_max DECIMAL(5,2) NOT NULL,
    rack_id uuid NOT NULL REFERENCES rack(id),
    rack_position integer NOT NULL,
    UNIQUE(rack_id, rack_position),
    CHECK (storage_temperature_min <= storage_temperature_max),
    CHECK (storage_humidity_min <= storage_humidity_max)
);

-- Вставка помещений
INSERT INTO room (id, name, volume, storage_temperature_min, storage_temperature_max, storage_humidity_min, storage_humidity_max) VALUES
('a1b2c3d4-e5f6-4789-a012-345678901234', 'Холодильная камера №1', 500.000, -2.00, 4.00, 85.00, 95.00),
('b2c3d4e5-f6a7-4890-b123-456789012345', 'Морозильная камера №1', 300.000, -25.00, -18.00, 90.00, 98.00),
('c3d4e5f6-a7b8-4901-c234-567890123456', 'Склад общего назначения №1', 1200.000, 15.00, 25.00, 40.00, 60.00),
('d4e5f6a7-b8c9-4012-d345-678901234567', 'Склад общего назначения №2', 800.000, 10.00, 20.00, 45.00, 65.00),
('e5f6a7b8-c9d0-4123-e456-789012345678', 'Холодильная камера №2', 450.000, 0.00, 6.00, 80.00, 90.00);

-- Вставка стеллажей
INSERT INTO rack (id, rack_number, room_id, positions_count, position_height, position_width, position_length, max_total_weight) VALUES
-- Стеллажи в холодильной камере №1
('f6a7b8c9-d0e1-4234-f567-890123456789', 'A-01', 'a1b2c3d4-e5f6-4789-a012-345678901234', 5, 0.500, 1.200, 0.800, 500.000),
('a7b8c9d0-e1f2-4345-a678-901234567890', 'A-02', 'a1b2c3d4-e5f6-4789-a012-345678901234', 5, 0.500, 1.200, 0.800, 500.000),
('b8c9d0e1-f2a3-4456-b789-012345678901', 'A-03', 'a1b2c3d4-e5f6-4789-a012-345678901234', 4, 0.600, 1.000, 0.900, 600.000),

-- Стеллажи в морозильной камере №1
('c9d0e1f2-a3b4-4567-c890-123456789012', 'B-01', 'b2c3d4e5-f6a7-4890-b123-456789012345', 6, 0.400, 1.000, 0.700, 400.000),
('d0e1f2a3-b4c5-4678-d901-234567890123', 'B-02', 'b2c3d4e5-f6a7-4890-b123-456789012345', 6, 0.400, 1.000, 0.700, 400.000),

-- Стеллажи в складе общего назначения №1
('e1f2a3b4-c5d6-4789-e012-345678901234', 'C-01', 'c3d4e5f6-a7b8-4901-c234-567890123456', 8, 0.800, 1.500, 1.200, 1000.000),
('f2a3b4c5-d6e7-4890-f123-456789012345', 'C-02', 'c3d4e5f6-a7b8-4901-c234-567890123456', 8, 0.800, 1.500, 1.200, 1000.000),
('a3b4c5d6-e7f8-4901-a234-567890123456', 'C-03', 'c3d4e5f6-a7b8-4901-c234-567890123456', 10, 0.700, 1.300, 1.000, 800.000),
('b4c5d6e7-f8a9-4012-b345-678901234567', 'C-04', 'c3d4e5f6-a7b8-4901-c234-567890123456', 10, 0.700, 1.300, 1.000, 800.000),

-- Стеллажи в складе общего назначения №2
('c5d6e7f8-a9b0-4123-c456-789012345678', 'D-01', 'd4e5f6a7-b8c9-4012-d345-678901234567', 6, 0.600, 1.200, 0.900, 700.000),
('d6e7f8a9-b0c1-4234-d567-890123456789', 'D-02', 'd4e5f6a7-b8c9-4012-d345-678901234567', 6, 0.600, 1.200, 0.900, 700.000),

-- Стеллажи в холодильной камере №2
('e7f8a9b0-c1d2-4345-e678-901234567890', 'E-01', 'e5f6a7b8-c9d0-4123-e456-789012345678', 5, 0.500, 1.100, 0.800, 550.000),
('f8a9b0c1-d2e3-4456-f789-012345678901', 'E-02', 'e5f6a7b8-c9d0-4123-e456-789012345678', 5, 0.500, 1.100, 0.800, 550.000),

-- Стеллаж с нулевыми размерами (для проверки запроса - объем должен быть 0)
('a9b0c1d2-e3f4-4567-a890-123456789abc', 'F-01', 'c3d4e5f6-a7b8-4901-c234-567890123456', 10, 0.000, 0.000, 0.000, 0.000);

-- Вставка клиентов
INSERT INTO client (id, company_name, bank_details) VALUES
('a9b0c1d2-e3f4-4567-a890-123456789012', 'ООО "ПродуктТорг"', 'БИК: 044525225, ИНН: 7707083893, КПП: 770701001, р/с: 40702810100000000001, Банк: ПАО "Сбербанк", к/с: 30101810400000000225'),
('b0c1d2e3-f4a5-4678-b901-234567890123', 'АО "МясоПром"', 'БИК: 044525225, ИНН: 7707083894, КПП: 770701002, р/с: 40702810200000000002, Банк: ПАО "Сбербанк", к/с: 30101810400000000225'),
('c1d2e3f4-a5b6-4789-c012-345678901234', 'ООО "ХолодСнаб"', 'БИК: 044525593, ИНН: 7707083895, КПП: 770701003, р/с: 40702810300000000003, Банк: АО "Альфа-Банк", к/с: 30101810200000000593'),
('d2e3f4a5-b6c7-4890-d123-456789012345', 'ИП Иванов Иван Иванович', 'БИК: 044525225, ИНН: 7707083896, р/с: 40802810400000000004, Банк: ПАО "Сбербанк", к/с: 30101810400000000225'),
('e3f4a5b6-c7d8-4901-e234-567890123456', 'ООО "ЭкоПродукт"', 'БИК: 044525225, ИНН: 7707083897, КПП: 770701004, р/с: 40702810500000000005, Банк: ПАО "Сбербанк", к/с: 30101810400000000225'),
('f4a5b6c7-d8e9-4012-f345-678901234567', 'АО "Молочный Союз"', 'БИК: 044525593, ИНН: 7707083898, КПП: 770701005, р/с: 40702810600000000006, Банк: АО "Альфа-Банк", к/с: 30101810200000000593'),
-- Клиент без товаров (для проверки запроса - должен показываться с количеством 0)
('a5b6c7d8-e9f0-4123-a456-789012345abc', 'ООО "НовыйКлиент"', 'БИК: 044525225, ИНН: 7707083899, КПП: 770701006, р/с: 40702810700000000007, Банк: ПАО "Сбербанк", к/с: 30101810400000000225');

-- Вставка товаров
INSERT INTO product (id, height, width, length, weight, receipt_date, contract_number, client_id, contract_end_date, storage_temperature_min, storage_temperature_max, storage_humidity_min, storage_humidity_max, rack_id, rack_position) VALUES
-- Товары в холодильной камере №1
('a5b6c7d8-e9f0-4123-a456-789012345678', 0.400, 0.500, 0.600, 25.500, '2024-01-15', 'ДОГ-2024-001', 'a9b0c1d2-e3f4-4567-a890-123456789012', '2024-07-15', -2.00, 4.00, 85.00, 95.00, 'f6a7b8c9-d0e1-4234-f567-890123456789', 1),
('b6c7d8e9-f0a1-4234-b567-890123456789', 0.450, 0.550, 0.650, 28.000, '2024-01-20', 'ДОГ-2024-001', 'a9b0c1d2-e3f4-4567-a890-123456789012', '2024-07-15', -2.00, 4.00, 85.00, 95.00, 'f6a7b8c9-d0e1-4234-f567-890123456789', 2),
('c7d8e9f0-a1b2-4345-c678-901234567890', 0.350, 0.450, 0.550, 20.000, '2024-02-01', 'ДОГ-2024-002', 'b0c1d2e3-f4a5-4678-b901-234567890123', '2024-08-01', -2.00, 4.00, 85.00, 95.00, 'a7b8c9d0-e1f2-4345-a678-901234567890', 1),
('d8e9f0a1-b2c3-4456-d789-012345678901', 0.500, 0.600, 0.700, 32.500, '2024-02-05', 'ДОГ-2024-002', 'b0c1d2e3-f4a5-4678-b901-234567890123', '2024-08-01', -2.00, 4.00, 85.00, 95.00, 'a7b8c9d0-e1f2-4345-a678-901234567890', 2),
('e9f0a1b2-c3d4-4567-e890-123456789012', 0.400, 0.500, 0.600, 26.000, '2024-02-10', 'ДОГ-2024-003', 'c1d2e3f4-a5b6-4789-c012-345678901234', '2024-08-10', -2.00, 4.00, 85.00, 95.00, 'b8c9d0e1-f2a3-4456-b789-012345678901', 1),

-- Товары в морозильной камере №1
('f0a1b2c3-d4e5-4678-f901-234567890123', 0.300, 0.400, 0.500, 18.500, '2024-01-10', 'ДОГ-2024-004', 'b0c1d2e3-f4a5-4678-b901-234567890123', '2024-07-10', -25.00, -18.00, 90.00, 98.00, 'c9d0e1f2-a3b4-4567-c890-123456789012', 1),
('a1b2c3d4-e5f6-4789-a012-345678901234', 0.350, 0.450, 0.550, 22.000, '2024-01-12', 'ДОГ-2024-004', 'b0c1d2e3-f4a5-4678-b901-234567890123', '2024-07-10', -25.00, -18.00, 90.00, 98.00, 'c9d0e1f2-a3b4-4567-c890-123456789012', 2),
('b2c3d4e5-f6a7-4890-b123-456789012345', 0.300, 0.400, 0.500, 19.000, '2024-01-18', 'ДОГ-2024-005', 'a9b0c1d2-e3f4-4567-a890-123456789012', '2024-07-18', -25.00, -18.00, 90.00, 98.00, 'c9d0e1f2-a3b4-4567-c890-123456789012', 3),
('c3d4e5f6-a7b8-4901-c234-567890123456', 0.320, 0.420, 0.520, 20.500, '2024-01-25', 'ДОГ-2024-005', 'a9b0c1d2-e3f4-4567-a890-123456789012', '2024-07-18', -25.00, -18.00, 90.00, 98.00, 'd0e1f2a3-b4c5-4678-d901-234567890123', 1),

-- Товары в складе общего назначения №1
('d4e5f6a7-b8c9-4012-d345-678901234567', 0.700, 0.800, 1.000, 45.000, '2024-01-05', 'ДОГ-2024-006', 'd2e3f4a5-b6c7-4890-d123-456789012345', '2024-07-05', 15.00, 25.00, 40.00, 60.00, 'e1f2a3b4-c5d6-4789-e012-345678901234', 1),
('e5f6a7b8-c9d0-4123-e456-789012345678', 0.750, 0.850, 1.100, 50.000, '2024-01-08', 'ДОГ-2024-006', 'd2e3f4a5-b6c7-4890-d123-456789012345', '2024-07-05', 15.00, 25.00, 40.00, 60.00, 'e1f2a3b4-c5d6-4789-e012-345678901234', 2),
('f6a7b8c9-d0e1-4234-f567-890123456789', 0.650, 0.750, 0.950, 42.000, '2024-01-12', 'ДОГ-2024-007', 'e3f4a5b6-c7d8-4901-e234-567890123456', '2024-07-12', 15.00, 25.00, 40.00, 60.00, 'f2a3b4c5-d6e7-4890-f123-456789012345', 1),
('a7b8c9d0-e1f2-4345-a678-901234567890', 0.700, 0.800, 1.000, 48.000, '2024-01-15', 'ДОГ-2024-007', 'e3f4a5b6-c7d8-4901-e234-567890123456', '2024-07-12', 15.00, 25.00, 40.00, 60.00, 'f2a3b4c5-d6e7-4890-f123-456789012345', 2),
('b8c9d0e1-f2a3-4456-b789-012345678901', 0.600, 0.700, 0.900, 38.000, '2024-01-20', 'ДОГ-2024-008', 'f4a5b6c7-d8e9-4012-f345-678901234567', '2024-07-20', 15.00, 25.00, 40.00, 60.00, 'a3b4c5d6-e7f8-4901-a234-567890123456', 1),
('c9d0e1f2-a3b4-4567-c890-123456789012', 0.650, 0.750, 0.950, 40.000, '2024-01-22', 'ДОГ-2024-008', 'f4a5b6c7-d8e9-4012-f345-678901234567', '2024-07-20', 15.00, 25.00, 40.00, 60.00, 'a3b4c5d6-e7f8-4901-a234-567890123456', 2),
('d0e1f2a3-b4c5-4678-d901-234567890123', 0.700, 0.800, 1.000, 46.000, '2024-01-25', 'ДОГ-2024-009', 'a9b0c1d2-e3f4-4567-a890-123456789012', '2024-07-25', 15.00, 25.00, 40.00, 60.00, 'b4c5d6e7-f8a9-4012-b345-678901234567', 1),

-- Товары в складе общего назначения №2
('e1f2a3b4-c5d6-4789-e012-345678901234', 0.550, 0.650, 0.850, 35.000, '2024-02-01', 'ДОГ-2024-010', 'c1d2e3f4-a5b6-4789-c012-345678901234', '2024-08-01', 10.00, 20.00, 45.00, 65.00, 'c5d6e7f8-a9b0-4123-c456-789012345678', 1),
('f2a3b4c5-d6e7-4890-f123-456789012345', 0.600, 0.700, 0.900, 38.500, '2024-02-03', 'ДОГ-2024-010', 'c1d2e3f4-a5b6-4789-c012-345678901234', '2024-08-01', 10.00, 20.00, 45.00, 65.00, 'c5d6e7f8-a9b0-4123-c456-789012345678', 2),
('a3b4c5d6-e7f8-4901-a234-567890123456', 0.550, 0.650, 0.850, 36.000, '2024-02-05', 'ДОГ-2024-011', 'd2e3f4a5-b6c7-4890-d123-456789012345', '2024-08-05', 10.00, 20.00, 45.00, 65.00, 'd6e7f8a9-b0c1-4234-d567-890123456789', 1),

-- Товары в холодильной камере №2
('b4c5d6e7-f8a9-4012-b345-678901234567', 0.400, 0.500, 0.600, 24.000, '2024-02-08', 'ДОГ-2024-012', 'f4a5b6c7-d8e9-4012-f345-678901234567', '2024-08-08', 0.00, 6.00, 80.00, 90.00, 'e7f8a9b0-c1d2-4345-e678-901234567890', 1),
('c5d6e7f8-a9b0-4123-c456-789012345678', 0.450, 0.550, 0.650, 27.500, '2024-02-10', 'ДОГ-2024-012', 'f4a5b6c7-d8e9-4012-f345-678901234567', '2024-08-08', 0.00, 6.00, 80.00, 90.00, 'e7f8a9b0-c1d2-4345-e678-901234567890', 2),
('d6e7f8a9-b0c1-4234-d567-890123456789', 0.400, 0.500, 0.600, 25.000, '2024-02-12', 'ДОГ-2024-013', 'e3f4a5b6-c7d8-4901-e234-567890123456', '2024-08-12', 0.00, 6.00, 80.00, 90.00, 'f8a9b0c1-d2e3-4456-f789-012345678901', 1);

-- Номера стеллажей, а также объём одного места и суммарный объём всех мест на каждом из них.
SELECT 
	rack_number, 
	(r.position_height * r.position_width * r.position_length) AS position_volume,
	(r.position_height * r.position_width * r.position_length * r.positions_count) AS total_volume
FROM rack r;

-- Названия юр. лиц всех клиентов и количество их товаров на стеллажах.
SELECT 
	c.company_name, 
	COUNT(p.id) AS products_on_racks 
FROM client c 
LEFT JOIN product p ON c.id = p.client_id 
GROUP BY c.id, c.company_name;
